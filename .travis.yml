sudo: required
services:
  - docker

env:
  COMPOSE_VERSION: 1.4.1

before_install:
 - curl -sSL https://get.docker.com/ | sudo sh
 - sudo pip install docker-compose
 - cp docker-compose.yml docker-compose_tmpl.yml
 - cp Dockerfile Dockerfile_tmpl
 - cp Dockerfile_shinyr Dockerfile_shinyr_tmpl
 - grep -vi proxy docker-compose_tmpl.yml > docker-compose.yml
 - grep -vi proxy Dockerfile_tmpl > Dockerfile
 - grep -vi proxy Dockerfile_shinyr_tmpl > Dockerfile_shinyr

script:
  - docker-compose up -d
  - docker-compose ps

after_install:
  - docker exec -it kaka_web_1 ./manage migrate;\
        psql -h db -U postgres < onto.sql;\
        ./manage.py runscript seafood_load_tree;

deploy:
  provider: releases
  api_key: "GITHUB OAUTH TOKEN"
  file: "FILE TO UPLOAD"
  skip_cleanup: true
  on:
    tags: true

notifications:
  irc:
    channels:
      - "irc.freenode.org#inasafe"
    use_notice: true

  email:
    - helge.dzierzon@plantandfood.co.nz
